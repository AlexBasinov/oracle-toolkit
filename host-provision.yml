# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---

# - name: Populate variables
#   hosts: dbasm
#   tasks:
#   - include_role:
#       name: common
#       tasks_from: populate-vars.yml
#   tags: populate-vars

- name: Create user and set up ssh equivalence
  hosts: dbasm
  vars_prompt:
    - name: ansible_password
      prompt: Enter customeradmin password
  become: yes
  pre_tasks:
    - name: Verify that Ansible on control node meets the version requirements
      assert:
        that: "ansible_version.full is version_compare('2.8', '>=')"
        fail_msg: "You must update Ansible to at least 2.8 to use these playbooks"
        success_msg: "Ansible version is {{ ansible_version.full }}, continuing"
  tasks:
  - include_role:
      name: host-provision
      tasks_from: user-setup.yml
  remote_user: "customeradmin"
  tags: host-provision

  # roles:
  #   # - { role: base-provision, tags: base-provision }
  #   # - { role: host-storage, tags: host-storage }
  #   # - { role: ora-host, tags: ora-host }
  #   # - { role: hugepages, tags: hugepages }
  #   - { role: host-provision, tags: host-provision }

# - hosts: dbasm[0]
#   become: no
#   roles:
#     - { role: swlib, tags: swlib }

# ---
# - name: OPatch Restart patch
#   hosts: dbasm
#   pre_tasks:
#   - name: Verify that Ansible on control node meets the version requirements
#     assert:
#       that: "ansible_version.full is version_compare('2.8', '>=')"
#       fail_msg: "You must update Ansible to at least 2.8 to use these playbooks"
#       success_msg: "Ansible version is {{ ansible_version.full }}, continuing"
#   tasks:
#   - include_role:
#       name: patch
#       tasks_from: main.yml
#     when: hostvars[groups['dbasm'].0]['cluster_name']|default('', true)|length == 0
#   remote_user: "{{ oracle_user }}"
#   become: yes
#   become_user: root
#   tags: opatch_restart

# - name: RAC patch apply
#   hosts: dbasm
#   serial: 1
#   order: inventory
#   tasks:
#   - include_role:
#       name: patch
#       tasks_from: rac-opatch.yml
#     vars:
#       db_config_type: RAC
#     when: hostvars[groups['dbasm'].0]['cluster_name']|default('', true)|length > 0
#   tags: rac-opatch