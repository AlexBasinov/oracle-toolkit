# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: build_file_list | Initialize file list variables
  set_fact:
    opatch_file_list: []
    gi_base_files: []
    rdbms_base_files: []
    base_sw_file_list: []
    patch_details_list: []
    patch_file_list: []

- name: build_file_list | Get OPatch file name
  set_fact:
    opatch_file_list: "{{ opatch_patches | selectattr('release', 'equalto', oracle_ver) | map(attribute='patchfile') | list }}"
  when:
    - not free_edition
    - oracle_rel != "base"

- name: build_file_list | Build list of GI base software and interim patches
  set_fact:
    gi_base_files: >-
      {{ (gi_software + gi_interim_patches)
         | selectattr('version', 'equalto', oracle_ver)
         | map(attribute='files')
         | flatten
      }}
  when:
    - gi_install
    - patch_only is not defined

- name: build_file_list | Build list of RDBMS base software by valid OS major version
  set_fact:
    rdbms_version_sw: "{{ (rdbms_software | selectattr('os_version', 'undefined') | list)
                        +
                        (rdbms_software
                        | selectattr('os_version', 'defined')
                        | selectattr('os_version', 'equalto', ansible_distribution_major_version)
                        | list)
                        +
                        (rdbms_software
                        | selectattr('os_version', 'defined')
                        | selectattr('os_version', 'search', '\\b' + ansible_distribution_major_version + '\\b')
                        | list)
                       }}"

- name: build_file_list | Refine list of RDBMS base software by edition
  set_fact:
    rdbms_edition_sw: "{{ (rdbms_version_sw | selectattr('edition', 'equalto', oracle_edition) | list)
                        + (rdbms_version_sw | selectattr('edition', 'search', '\\b' + oracle_edition + '\\b') | list)
                       }}"

- name: build_file_list | Build list of RDBMS base software
  set_fact:
    rdbms_base_files: >-
      {{ rdbms_edition_sw
         | selectattr('version', 'equalto', oracle_ver)
         | map(attribute='files')
         | flatten
         | unique
       }}
  when: patch_only is not defined

- name: build_file_list | Build list of all base software (with alternative names)
  set_fact:
    base_sw_file_list: "{{ (gi_base_files + rdbms_base_files) | json_query('[*].{file_name:name,alt_name:alt_name}') }}"

- name: build_file_list | Build list of GI patches
  set_fact:
    patch_details_list: >-
      {{ ( patch_details_list + gi_patches
           | selectattr('release', 'equalto', oracle_rel)
           | list )
         | unique
      }}
  when: gi_install

- name: build_file_list | Build list of RDBMS patches for GI installations
  set_fact:
    patch_details_list: >-
      {{ ( patch_details_list + rdbms_patches
           | selectattr('release', 'equalto', oracle_rel)
           | selectattr('category', 'equalto', 'RU_Combo')
           | list )
         | unique
      }}
  when: gi_install

- name: build_file_list | Build list of RDBMS patches
  set_fact:
    patch_details_list: >-
      {{ ( patch_details_list + rdbms_patches
           | selectattr('release', 'equalto', oracle_rel)
           | selectattr('category', 'in', ['DB_OJVM_RU','DB_RU'])
           | list )
         | unique
      }}
  when:
    - not gi_install
    - not free_edition

- name: build_file_list | Build list of unique patch file names
  set_fact:
    patch_file_list: "{{ patch_details_list | map(attribute='patchfile') | unique | list }}"

- name: build_file_list | Extract required OPatch versions from patch file list
  set_fact:
    patch_opatch_versions: "{{ patch_details_list | selectattr('minimum_opatch', 'defined') | map(attribute='minimum_opatch') | list }}"
  when:
    - not free_edition
    - oracle_rel != "base"

- name: build_file_list | Determine exact OPatch version required
  set_fact:
    required_opatch_version: >-
      {{ item if (required_opatch_version is not defined or item is version(required_opatch_version, '>'))
         else required_opatch_version }}
  when: item is defined and item | length > 0
  with_items: "{{ patch_opatch_versions }}"

- name: build_file_list | Display file lists
  debug:
    msg:
      required_opatch_version: "{{ required_opatch_version | default('N/A: Not defined in patch metadata') }}"
      opatch_file_list: "{{ opatch_file_list }}"
      base_sw_file_list: "{{ base_sw_file_list }}"
      patch_file_list: "{{ patch_file_list }}"
    verbosity: 1
