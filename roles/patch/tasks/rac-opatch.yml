# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

---
- name: rac-opatch | Create OCM response file
  script: expect_rsp.sh {{ oracle_base }} {{ oracle_home }} {{ swlib_unzip_path }}
  args:
    creates: "{{ swlib_unzip_path }}/ocm.rsp"
  with_items:
    - "{{ rdbms_patches }}"
    - "{{ gi_patches }}"
  when:
    - item.ocm
    - item.release == oracle_ver
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch

- name: rac-opatch | 12.2 bug resolution - MOS (Doc ID 2401455.1)
  copy:
    src: "{{ oracle_root }}/oraInventory/oraInst.loc"
    dest: "{{ grid_home }}/oraInst.loc"
    remote_src: yes
    owner: "{{ grid_user }}"
    group: "{{ oracle_group }}"
    mode: u=rw,g=r,o=
  when: oracle_ver == '12.2.0.1.0'
  become: yes
  become_user: root

- name: rac-opatch | Copy patches from bucket
  import_role:
    name: swlib
    tasks_from: gcscopy
  vars:
    patching_type: gi_patching
  tags: rac-opatch,sw-copy

- name: rac-opatch | Update GI OPatch
  unarchive:
    src: "{{ swlib_path }}/{{ item.patchfile }}"
    dest: "{{ grid_home }}"
    remote_src: yes
  with_items:
    - "{{ opatch_patches }}"
  when:
    - item.release == oracle_ver
    - item.category == "OPatch"
  become: yes
  become_user: "{{ grid_user }}"
  tags: rac-opatch

- name: rac-opatch | Update RDBMS OPatch
  unarchive:
    src: "{{ swlib_path }}/{{ item.patchfile }}"
    dest: "{{ oracle_home }}"
    remote_src: yes
  with_items:
    - "{{ opatch_patches }}"
  when:
    - item.release == oracle_ver
    - item.category == "OPatch"
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch

- name: rac-opatch | Unzip GI patch
  unarchive:
    src: "{{ swlib_path }}/{{ item.patchfile }}"
    dest: "{{ swlib_unzip_path }}"
    remote_src: yes
    owner: "{{ grid_user }}"
    group: "{{ oracle_group }}"
  with_items:
    - "{{ gi_patches }}"
  when: item.release == oracle_rel and item.category != "HAS_interim_patch"
  become: yes
  tags: rac-opatch

- name: rac-opatch | Run GI opatch analyze
  command: "{{ grid_home }}/OPatch/{{ patch.method }} -analyze"
  args:
    chdir: "{{ swlib_unzip_path }}/{{ patch.patchnum }}/{{ patch.patch_subdir }}"
  loop: "{{ gi_patches | json_query('[?release==`'+ oracle_rel +'`]') }}"
  loop_control:
    loop_var: patch
  when:
    - not patch.prereq_check
    - oracle_ver != '11.2.0.4.0'
  register: opatch_analyze
  changed_when: false
  failed_when: "'Analysis for the patches failed' in opatch_analyze.stdout"
  become: yes
  tags: rac-opatch

- name: rac-opatch | GI opatch analyze output
  debug: var=opatch_analyze.results.stdout_lines
  when: opatch_analyze is defined
  tags: rac-opatch

- name: rac-opatch | Copy oui-patch.xml to remote nodes (bug from MOS 2582139.1)
  command: "scp -p {{ oracle_inventory }}/ContentsXML/oui-patch.xml {{ item }}:{{ oracle_inventory }}/ContentsXML/oui-patch.xml"
  loop: "{{ groups['dbasm'] }}"
  when:
    - item != inventory_hostname
    - inventory_hostname == groups['dbasm'].0
    - oracle_rel | regex_search('^19\.[3-6]\.') | default('', true) | length > 0
  become: yes
  become_user: "{{ grid_user }}"
  tags: rac-opatch,bug-opatch

- name: rac-opatch | Remove db_state.out if it exists
  file:
    path: "{{ swlib_unzip_path }}/db_state.out"
    state: absent
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch,stop-home

- name: rac-opatch | Define node variable
  set_fact:
    node_var: "-node {{ inventory_hostname }}"
  tags: rac-opatch,stop-home

- name: rac-opatch | Stop RDBMS home
  command: "{{ oracle_home }}/bin/srvctl stop home -o {{ oracle_home }} -t immediate -s {{ swlib_unzip_path }}/db_state.out {{ node_var }}"
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
  register: stop_home
  failed_when: stop_home.rc not in [0,2]
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch,stop-home

- name: rac-opatch | Run GI opatch apply
  command: "{{ grid_home }}/OPatch/{{ patch.method }} {{ '-ocmrf {{ swlib_unzip_path }}/ocm.rsp' if patch.ocm else '' }}"
  args:
    chdir: "{{ swlib_unzip_path }}/{{ patch.patchnum }}{{ patch.patch_subdir }}"
  loop: "{{ gi_patches | json_query('[?release==`'+ oracle_rel +'`]') }}"
  loop_control:
    loop_var: patch
  when: oracle_ver != '11.2.0.4.0'
  register: opatch_apply
  become: yes
  tags: rac-opatch

- name: rac-opatch | Results of GI opatch apply
  debug: var=opatch_apply.results.stdout_lines
  when: opatch_apply is defined
  tags: rac-opatch

- name: rac-opatch | 12.1 bug resolution - MOS (Doc ID 1084186.1)
  shell: |
    set -o pipefail
    setasmgidwrap o={{ oracle_home }}/bin/oracle
  environment:
    ORACLE_HOME: "{{ grid_home }}"
    ORACLE_SID: "{{ asm_sid }}"
    PATH: "{{ grid_home }}/bin:/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin"
  args:
    chdir: "{{ grid_home }}/bin"
  when: oracle_ver == '12.1.0.2.0'
  register: setasmgidwrap_output
  become: yes
  become_user: "{{ grid_user }}"
  tags: rac-opatch

- name: rac-opatch | 12.1 bug resolution results
  debug: var=setasmgidwrap_output
  when: oracle_ver == '12.1.0.2.0'
  tags: rac-opatch

- name: rac-opatch | Pause for 90 seconds due to delayed startup after opatch on 12c
  wait_for:
    timeout: 90
  delegate_to: localhost
  when: oracle_ver in ['12.1.0.2.0','12.2.0.1.0'] and home_type == 'GRID'
  tags: rac-opatch

- name: rac-opatch | Copy RDBMS patches
  import_role:
    name: swlib
    tasks_from: gcscopy
  vars:
    patching_type: db_patching
  tags: rac-opatch,sw-copy

- name: rac-opatch | Unzip RDBMS patch
  unarchive:
    src: "{{ swlib_path }}/{{ item.patchfile }}"
    dest: "{{ swlib_unzip_path }}"
    remote_src: yes
    owner: "{{ oracle_user }}"
    group: "{{ oracle_group }}"
  with_items:
    - "{{ rdbms_patches }}"
  when: item.release == oracle_rel
  become: yes
  tags: rac-opatch,sw_unzip

- name: rac-opatch | Run RDBMS opatch analyze
  command: "{{ oracle_home }}/OPatch/{{ patch.method }} -analyze"
  args:
    chdir: "{{ swlib_unzip_path }}/{{ patch.patchnum }}/{{ patch.patch_subdir }}"
  loop: "{{ rdbms_patches | json_query('[?release==`'+ oracle_rel +'`]') }}"
  loop_control:
    loop_var: patch
  when:
    - not patch.prereq_check
    - oracle_ver != '11.2.0.4.0'
  register: opatch_analyze
  ignore_errors: true
  changed_when: false
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch

- name: rac-opatch | RDBMS opatch analyze output
  debug: var=opatch_analyze
  when: opatch_analyze is defined
  tags: rac-opatch

- name: rac-opatch | Run RDBMS opatch apply
  command: "{{ oracle_home }}/OPatch/{{ patch.method }} -silent {{ '-ocmrf {{ swlib_unzip_path }}/ocm.rsp' if patch.ocm else '' }}"
  args:
    chdir: "{{ swlib_unzip_path }}/{{ patch.patchnum }}{{ patch.patch_subdir }}"
  loop: "{{ rdbms_patches | json_query('[?release==`'+ oracle_rel +'`]') }}"
  loop_control:
    loop_var: patch
  when: oracle_ver != '11.2.0.4.0'
  register: opatch_apply
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch

- name: rac-opatch | Results of RDBMS opatch apply
  debug: var=opatch_apply.results.stdout_lines
  when: opatch_apply is defined
  tags: rac-opatch

- name: rac-opatch | Start RDBMS home
  command: "{{ oracle_home }}/bin/srvctl start home -o {{ oracle_home }} -s {{ swlib_unzip_path }}/db_state.out  {{ node_var }}"
  environment:
    ORACLE_HOME: "{{ oracle_home }}"
  register: start_home
  failed_when: start_home.rc not in [0,2]
  become: yes
  become_user: "{{ oracle_user }}"
  tags: rac-opatch,start-home
